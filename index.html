<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khetan Packfine ITSM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

    <style>
        :root {
            --primary-color: #0f172a;
            --secondary-color: #3b82f6;
            --accent-color: #f59e0b;
            --bg-color: #f8fafc;
            --surface-color: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --purple: #8b5cf6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        .hidden { display: none !important; }

        /* Login Screen */
        #login-view { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, var(--primary-color), #1e3a8a); position: absolute; top: 0; left: 0; z-index: 2000; padding: 20px; }
        .login-card { background: white; padding: 40px; border-radius: 10px; width: 100%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); text-align: center; }
        .login-card h2 { margin-bottom: 10px; color: var(--primary-color); }
        .login-card p { color: var(--text-muted); margin-bottom: 30px; font-size: 14px; }
        .demo-logins { display: flex; flex-direction: column; gap: 15px; }
        .btn-login { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 16px; }
        .btn-admin { background: var(--primary-color); color: white; }
        .btn-admin:hover { background: #1e293b; }
        .btn-user { background: var(--bg-color); color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-user:hover { background: #e2e8f0; }

        /* Main App Layout */
        #app-view { width: 100vw; height: 100vh; display: flex; }
        .sidebar { width: 260px; background-color: var(--primary-color); color: white; display: flex; flex-direction: column; transition: left 0.3s ease; z-index: 1000; }
        .logo-area { padding: 25px 20px; font-size: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; justify-content: space-between; }
        .logo-area i { color: var(--secondary-color); }
        
        .close-sidebar { display: none; background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

        .nav-links { list-style: none; padding: 20px 0; flex-grow: 1; }
        .nav-links li { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #cbd5e1; font-weight: 500; transition: 0.2s; }
        .nav-links li:hover { background-color: rgba(255,255,255,0.05); color: white; }
        .nav-links li.active { background-color: var(--secondary-color); color: white; border-left: 4px solid var(--accent-color); }

        .main-wrapper { flex-grow: 1; display: flex; flex-direction: column; width: calc(100% - 260px); }
        
        .top-bar { height: 70px; background: var(--surface-color); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; padding: 0 30px; }
        .top-bar-left { display: flex; align-items: center; gap: 15px; }
        .menu-toggle { display: none; font-size: 24px; color: var(--primary-color); cursor: pointer; background: none; border: none; }
        
        .user-profile { display: flex; align-items: center; gap: 15px; font-weight: bold; }
        .btn-logout { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-logout:hover { background: var(--danger); color: white; }
        
        .content-area { padding: 30px; overflow-y: auto; flex-grow: 1; }
        .module { display: none; }
        .module.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .card { background: var(--surface-color); padding: 25px; border-radius: 10px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .stat-number { font-size: 38px; font-weight: bold; margin: 10px 0; }

        .incident-header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-primary { background: var(--secondary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; }
        .btn-primary:hover { background: #2563eb; }
        
        .incident-layout { display: flex; gap: 20px; height: calc(100vh - 180px); }
        .incident-list { flex: 1; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 10px; overflow-y: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .incident-detail { flex: 2; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 10px; padding: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow-y: auto; }
        
        .ticket-item { padding: 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: 0.2s; }
        .ticket-item:hover { background-color: #f1f5f9; }
        .ticket-item.active { background-color: #eff6ff; border-left: 4px solid var(--secondary-color); }
        .ticket-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; flex-wrap: wrap; gap: 10px;}
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; color: white; text-transform: uppercase; }
        .priority-high { color: var(--danger); font-weight: bold; }
        .priority-medium { color: var(--warning); font-weight: bold; }
        .priority-low { color: var(--success); font-weight: bold; }
        .status-open { background: var(--purple); }
        .status-picked_up { background: var(--info); }
        .status-pending { background: var(--warning); }
        .status-cannot_fix { background: var(--danger); }
        .status-resolved { background: var(--success); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000; padding: 15px; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group.full-width { grid-column: span 2; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; outline: none; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .btn-cancel { background: #e2e8f0; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .status-select { padding: 8px 15px; border-radius: 6px; border: 2px solid var(--border-color); font-weight: bold; font-size: 14px; cursor: pointer; outline: none; width: 100%; max-width: 200px;}
        .status-select:focus { border-color: var(--secondary-color); }

        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 900; }
        .sidebar-overlay.active { display: block; }

        @media (max-width: 1024px) {
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
            .incident-layout { flex-direction: column; height: auto; }
            .incident-list { min-height: 250px; max-height: 300px; }
            .incident-detail { min-height: 400px; flex: none; }
        }

        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .sidebar { position: fixed; left: -260px; height: 100vh; }
            .sidebar.active { left: 0; }
            .close-sidebar { display: block; }
            .main-wrapper { width: 100%; }
            .menu-toggle { display: block; }
            .top-bar { padding: 0 15px; }
            .content-area { padding: 15px; }
            .incident-header-controls { flex-direction: column; align-items: flex-start; gap: 15px; }
            .btn-primary { width: 100%; }
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width { grid-column: span 1; }
            .modal-content { padding: 20px; }
            .incident-detail > div:first-child { flex-direction: column; gap: 15px; }
            .status-select { max-width: 100%; }
        }
    </style>
</head>
<body>

<!-- LOGIN VIEW -->
<div id="login-view">
    <div class="login-card">
        <i class="fas fa-laptop-code" style="font-size: 40px; color: var(--secondary-color); margin-bottom: 15px;"></i>
        <h2>Khetan Group</h2>
        <p>IT Service Management Portal</p>
        <div class="demo-logins">
            <button class="btn-login btn-admin" onclick="performLogin('admin')"><i class="fas fa-user-shield"></i> Login as Admin</button>
            <button class="btn-login btn-user" onclick="performLogin('user')"><i class="fas fa-user-graduate"></i> Login as Employee</button>
        </div>
    </div>
</div>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- MAIN APP VIEW -->
<div id="app-view" class="hidden">
    <nav class="sidebar" id="sidebar">
        <div class="logo-area">
            <div><i class="fas fa-laptop-code"></i> Khetan ITSM</div>
            <button class="close-sidebar" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <ul class="nav-links">
            <li id="nav-dashboard" onclick="switchModule('dashboard', this)"><i class="fas fa-chart-pie"></i> System Dashboard</li>
            <li id="nav-incidents" onclick="switchModule('incidents', this)"><i class="fas fa-ticket-alt"></i> <span id="incident-nav-text">All Incidents</span></li>
        </ul>
    </nav>

    <div class="main-wrapper">
        <header class="top-bar">
            <div class="top-bar-left">
                <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <h2 id="portal-title" style="font-size: 1.2rem;">Admin Portal</h2>
            </div>
            <div class="user-profile">
                <span id="current-user-name" style="display: none;">Prem</span>
                <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <div class="content-area">
            <section id="dashboard" class="module">
                <h2 style="margin-bottom: 20px;"> Systems Overview</h2>
                <div class="dashboard-grid">
                    <div class="card">
                        <h3 style="color: var(--text-muted); font-size: 16px;">Action Required (Open)</h3>
                        <div class="stat-number" id="dash-open" style="color: var(--purple);">0</div>
                    </div>
                    <div class="card">
                        <h3 style="color: var(--text-muted); font-size: 16px;">Currently Working</h3>
                        <div class="stat-number" id="dash-working" style="color: var(--info);">0</div>
                    </div>
                    <div class="card">
                        <h3 style="color: var(--text-muted); font-size: 16px;">Unresolved / Cannot Fix</h3>
                        <div class="stat-number" id="dash-failed" style="color: var(--danger);">0</div>
                    </div>
                </div>
            </section>

            <section id="incidents" class="module">
                <div class="incident-header-controls">
                    <h2 id="incident-page-title">Incident Management</h2>
                    <button class="btn-primary" onclick="openModal()"><i class="fas fa-plus"></i> Create Ticket</button>
                </div>
                
                <div class="incident-layout">
                    <div class="incident-list" id="ticket-list-container"></div>
                    <div class="incident-detail" id="ticket-detail-container">
                        <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-muted); padding: 40px 0;">
                            <i class="fas fa-hand-pointer" style="font-size: 40px; margin-bottom: 15px; color: #cbd5e1;"></i>
                            <h3>Select an incident</h3>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal" id="ticketModal">
    <div class="modal-content">
        <h3 style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Submit Support Request</h3>
        <form id="ticketForm" onsubmit="handleCreateTicket(event)">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label>Issue Title</label>
                    <input type="text" id="t-title" required placeholder="e.g., Projector in Room 3 not working">
                </div>
                
                <div class="form-group">
                    <label>User / Employee Name</label>
                    <input type="text" id="t-emp-name" required placeholder="e.g., Prem Yerunkar">
                </div>

                <div class="form-group">
                    <label>Department</label>
                    <select id="t-dept">
                                                <option value="IT">IT</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Priority</label>
                    <select id="t-priority">
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label>Description</label>
                    <textarea id="t-desc" rows="4" placeholder="Describe the issue..." required></textarea>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn-primary">Submit Ticket</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- Initialize Supabase ---
    const SUPABASE_URL = "https://erlisoykftqjgghgbfct.supabase.co"; // <-- replace with your URL
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVybGlzb3lrZnRxamdnaGdiZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDQ3MTYsImV4cCI6MjA4NzU4MDcxNn0.Acbe3sjQz1ZM7Py38A6ZtuGk7EVKJmKJMhsESEOK7Iw";        // <-- replace with your key
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- UI Helpers ---
    const loginView = document.getElementById("login-view");
    const appView = document.getElementById("app-view");
    const sidebar = document.getElementById("sidebar");
    const sidebarOverlay = document.getElementById("sidebarOverlay");
    const ticketListContainer = document.getElementById("ticket-list-container");
    const ticketDetailContainer = document.getElementById("ticket-detail-container");
    const ticketModal = document.getElementById("ticketModal");

    let currentModule = "dashboard";
    let tickets = [];
    let currentUser = null;

    // --- Login Simulation ---
    function performLogin(role) {
        currentUser = { name: role === "admin" ? "Admin User" : "Employee User", role: role };
        document.getElementById("current-user-name").textContent = currentUser.name;
        loginView.classList.add("hidden");
        appView.classList.remove("hidden");
        if (role === "user") {
            document.getElementById("portal-title").textContent = "Employee Portal";
            document.getElementById("incident-nav-text").textContent = "My Incidents";
        }
        switchModule("dashboard");
        loadTickets();
    }

    function logout() {
        currentUser = null;
        loginView.classList.remove("hidden");
        appView.classList.add("hidden");
        tickets = [];
        ticketListContainer.innerHTML = "";
    }

    function switchModule(module, navItem) {
        document.querySelectorAll(".module").forEach(m => m.classList.remove("active"));
        document.getElementById(module).classList.add("active");

        document.querySelectorAll(".nav-links li").forEach(li => li.classList.remove("active"));
        if (navItem) navItem.classList.add("active");
        currentModule = module;
    }

    function toggleSidebar() {
        sidebar.classList.toggle("active");
        sidebarOverlay.classList.toggle("active");
    }

    function openModal() {
        ticketModal.classList.add("active");
    }

    function closeModal() {
        ticketModal.classList.remove("active");
    }

    // --- Ticket Handling ---
    async function loadTickets() {
        let { data, error } = await supabase
            .from("tickets")
            .select("*")
            .order("created_at", { ascending: false });

        if (error) {
            alert("Error fetching tickets: " + error.message);
            return;
        }

        // Filter if user role is not admin
        tickets = currentUser.role === "admin" ? data : data.filter(t => t.employee_name === currentUser.name);
        renderTicketList();
        updateDashboardStats();
    }

    function renderTicketList() {
        ticketListContainer.innerHTML = "";
        tickets.forEach(ticket => {
            const div = document.createElement("div");
            div.classList.add("ticket-item");
            div.innerHTML = `
                <div class="ticket-header">
                    <strong>${ticket.title}</strong>
                    <span class="priority-${ticket.priority.toLowerCase()}">${ticket.priority}</span>
                </div>
                <div>${ticket.department} - ${ticket.status || "Open"}</div>
            `;
            div.onclick = () => showTicketDetail(ticket);
            ticketListContainer.appendChild(div);
        });
    }

    function showTicketDetail(ticket) {
        ticketDetailContainer.innerHTML = `
            <h3>${ticket.title}</h3>
            <p><strong>Employee:</strong> ${ticket.employee_name}</p>
            <p><strong>Department:</strong> ${ticket.department}</p>
            <p><strong>Priority:</strong> ${ticket.priority}</p>
            <p><strong>Status:</strong> ${ticket.status || "Open"}</p>
            <hr>
            <p>${ticket.description}</p>
        `;
    }

    function updateDashboardStats() {
        const openCount = tickets.filter(t => !t.status || t.status === "Open").length;
        const workingCount = tickets.filter(t => t.status === "Picked Up").length;
        const failedCount = tickets.filter(t => t.status === "Cannot Fix").length;

        document.getElementById("dash-open").textContent = openCount;
        document.getElementById("dash-working").textContent = workingCount;
        document.getElementById("dash-failed").textContent = failedCount;
    }

    async function handleCreateTicket(event) {
        event.preventDefault();
        const newTicket = {
            title: document.getElementById("t-title").value,
            employee_name: document.getElementById("t-emp-name").value,
            department: document.getElementById("t-dept").value,
            priority: document.getElementById("t-priority").value,
            description: document.getElementById("t-desc").value,
            status: "Open",
            created_at: new Date().toISOString()
        };

        const { data, error } = await supabase
            .from("tickets")
            .insert([newTicket]);

        if (error) {
            alert("Error creating ticket: " + error.message);
            return;
        }

        tickets.unshift(data[0]);
        renderTicketList();
        updateDashboardStats();
        closeModal();
        document.getElementById("ticketForm").reset();
        alert("Ticket submitted successfully!");
    }
</script>
</body>
</html>
